<!DOCTYPE HTML>
<html>
    <head>
        <title>Movies Recommendation</title>
        <style>
            path {
                stroke: #fff;
                stroke-width: 0.3px;
            }

            path:hover {
                stroke: #eaeaea;
                stroke-width: 2px;
            }

            .stop-left {
                stop-color: #ebaaff; 
            }

            .stop-right {
                stop-color: #7f00c9; 
            }

                /* stop-color: #ffaab6;  */

                /* stop-color: #aaf3ff;  */

            .filled {
                fill: url(#mainGradient);
                stroke: url(#mainGradient);
                stroke-width: 3px;
            }

            .gender_filled {
                fill: url(#mainGenderGradient);
                stroke: url(#mainGenderGradient);
                stroke-width: 3px;
            }

            div.tooltip {		
                position: absolute;			
                text-align: center;			
                width: 320px;					
                height: 480px;					
                padding: 2px;				
                background: #f5eff7;	
                border: 0px;		
                border-radius: 8px;		
                right: 40px;		
            }
            
        </style>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script src="//d3js.org/topojson.v1.min.js"></script>
    </head>
    <body>
        <div id="svg-container">MovieLens Reviewer Demographics</div>
        <script>
            var width = 1250, height = 550;
            
            var div = d3.select("body").append("div")	
                        .attr("class", "tooltip")				
                        .style("opacity", 0);

            var svg = d3.select("body")
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height);

            var linear = d3.scale.linear().domain([0, 1100]).range([0, 1])
            var computeColor = d3.interpolate("#ebaaff", "#7f00c9")

            var svgDefs = svg.append("defs");

            var gradient = svgDefs.append("linearGradient").attr('id', 'mainGradient');
            gradient.append("stop").attr('class', 'stop-left').attr('offset', '0');
            gradient.append("stop").attr('class', 'stop-right').attr('offset', '1');

            var path = d3.geo.path();
            var pie = d3.layout.pie().value(function(d) {
                        return d.g;
                    })
            var arc = d3.svg.arc().outerRadius(20).innerRadius(0);
            
            var state_count = {};
            var state_gender_count = {};
            d3.csv("ml-1m/user_zip.csv", function(error, userData) {
                userData.forEach(function(d) {
                    var city = d.MI;
                    if (state_count[city] === undefined) {
                        state_count[city] = 0;
                        state_gender_count[city] = [];
                        for (var i = 0; i < 2; i++) {
                            state_gender_count[city].push({'g': 0});
                        }
                    } else {
                        state_count[city] += 1;
                        if (d.F === 'M') {
                            state_gender_count[city][0].g += 1;
                        } else {
                            state_gender_count[city][1].g += 1;
                        }
                    }
                })

                d3.json("usa-topo.json", function(error, usa) {
                    var geojson = topojson.feature(usa, usa.objects.tracts);
                    svg.selectAll("path")
                        .data(geojson.features)
                        .enter().append("path")
                        .attr("class", function(d) {return "state " + d.properties.STUSPS})
                        .attr("fill", function (d) {
                            return computeColor(linear(state_count[d.properties.STUSPS]));
                        })
                        .attr("d", path)
                        .on("mouseover", function(d) {
                                var total = state_count[d.properties.STUSPS][1] + state_count[d.properties.STUSPS][2];
                                // var g = svg.selectAll(".arc")
                                //            .data(pie(state_gender_count[d.properties.STUSPS]))
                                //            .enter().append("g")
                                //            .attr("class", "arc")
                                //            .attr("transform", "translate(" + d3.mouse(this)[0] + "," + d3.mouse(this)[1]+ ")");
                                // g.append("path").attr("d", arc).style("fill", function(d) {return "#ffaab6"})
                                div.transition().duration(200).style("opacity", 0.9);
                                var g = div.selectAll(".arc")
                                           .data(pie(state_gender_count[d.properties.STUSPS]))
                                           .enter().append("g")
                                           .attr("class", "arc")
                                g.append("path").attr("d", arc).style("fill", function(d) {return "#ffaab6"})
                                
                        })
                        .on("mouseout", function(d) {
                            d3.select(this).transition().attr('fill', function(d) {
                                return computeColor(linear(state_count[d.properties.STUSPS]));
                            })
                            div.transition()		
                               .duration(500)		
                               .style("opacity", 0);	
                        })
                        .append("title").text(d => `${d.properties.NAME}, ${state_count[d.properties.STUSPS]} users`)
                });
            });

            svg.append('rect')
                .classed('filled', true)
                .attr('x', width - 200)
                .attr('y', height - 45)
                .attr('width', 180)
                .attr('height', 20); 

            svg.append('text')
                .attr("x", width - 350)
                .attr("y", height - 30)
                .text('Number of Users')
                
            svg.append('text')
                .attr("x", width - 200)
                .attr("y", height - 10)
                .text("0")
            
            svg.append('text')
                .attr("x", width - 50)
                .attr("y", height - 10)
                .text("1099")

        </script>
    </body>
</html>