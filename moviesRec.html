<!DOCTYPE HTML>
<html>
    <head>
        <title>Movies Recommendation</title>
        <style>
            path {
                stroke: #fff;
                stroke-width: 0.3px;
            }

            path:hover {
                stroke: #eaeaea;
                stroke-width: 2px;
            }

            .stop-left {
                stop-color: #ebaaff; 
            }

            .stop-right {
                stop-color: #7f00c9; 
            }

                /* stop-color: #ffaab6;  */

                /* stop-color: #aaf3ff;  */

            .filled {
                fill: url(#mainGradient);
                stroke: url(#mainGradient);
                stroke-width: 3px;
            }

            .gender_filled {
                fill: url(#mainGenderGradient);
                stroke: url(#mainGenderGradient);
                stroke-width: 3px;
            }

            .svg-container {
                text-align: center;
            }
        </style>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script src="//d3js.org/topojson.v1.min.js"></script>
    </head>
    <body>
        <div class="svg-container">MovieLens Reviewer Demographics</div>
        <script>
            var height = 550;
            var map = d3.select("body")
                        .append("svg")
                        .attr("width", 900)
                        .attr("height", height);

            var details = d3.select("body")
                            .append("svg")
                            .attr("class", "a")
                            .attr("width", 350)
                            .attr("height", height);

            var svgDefs = map.append("defs");

            var gradient = svgDefs.append("linearGradient").attr('id', 'mainGradient');
            gradient.append("stop").attr('class', 'stop-left').attr('offset', '0');
            gradient.append("stop").attr('class', 'stop-right').attr('offset', '1');

            var linear = d3.scale.linear().domain([0, 1100]).range([0, 1])
            var computeColor = d3.interpolate("#ebaaff", "#7f00c9")

            var path = d3.geo.path();
            var pie = d3.layout.pie().value(function(d) { return d.g; })
            var arc = d3.svg.arc().outerRadius(50).innerRadius(10);
            
            var state_count = {};
            var state_gender_count = {};
            d3.csv("ml-1m/user_zip.csv", function(error, userData) {
                userData.forEach(function(d) {
                    var city = d.MI;
                    if (state_count[city] === undefined) {
                        state_count[city] = 0;
                        state_gender_count[city] = [];
                        for (var i = 0; i < 2; i++) {
                            state_gender_count[city].push({'g': 0});
                        }
                    } else {
                        state_count[city] += 1;
                        if (d.F === 'M') {
                            state_gender_count[city][0].g += 1;
                        } else {
                            state_gender_count[city][1].g += 1;
                        }
                    }
                })

                d3.json("usa-topo.json", function(error, usa) {
                    var geojson = topojson.feature(usa, usa.objects.tracts);
                    map.selectAll("path")
                        .data(geojson.features)
                        .enter().append("path")
                        .attr("class", function(d) {return "state " + d.properties.STUSPS})
                        .attr("fill", function (d) {
                            return computeColor(linear(state_count[d.properties.STUSPS]));
                        })
                        .attr("d", path)
                        .on("mouseover", function(d) {
                            var g = details.selectAll(".arc")
                                        .data(pie(state_gender_count[d.properties.STUSPS]))
                                        .enter().append("g")
                                        .attr("class", "arc")
                                        .attr("transform", "translate(" + 250 + "," + 300 + ")");
                            g.append("path").attr("d", arc).style("fill", function(d) {return "#ffaab6"})
                        })
                        .on("mouseout", function(d) {
                            d3.select(this).transition().attr('fill', function(d) {
                                return computeColor(linear(state_count[d.properties.STUSPS]));
                            })	
                        })
                        .append("title").text(d => `${d.properties.NAME}, ${state_count[d.properties.STUSPS]} users`)
                });
            });

            details.append('rect')
                .classed('filled', true)
                .attr('x', 140)
                .attr('y', height - 45)
                .attr('width', 180)
                .attr('height', 20); 

            details.append('text')
                .attr("x", 2)
                .attr("y", height - 30)
                .text('Number of Users')
                
            details.append('text')
                .attr("x", 140)
                .attr("y", height)
                .text("0")
            
            details.append('text')
                .attr("x", 288)
                .attr("y", height)
                .text("1099")

        </script>
    </body>
</html>